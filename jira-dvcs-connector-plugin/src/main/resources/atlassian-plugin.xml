<atlassian-plugin key="com.atlassian.jira.plugins.jira-bitbucket-connector-plugin" name="${project.name}" plugins-version="2">

    <plugin-info>
        <description>${project.description}</description>
        <version>${project.version}</version>
        <vendor name="${project.organization.name}" url="${project.organization.url}"/>
    </plugin-info>

    <component-import key="templateRenderer" interface="com.atlassian.templaterenderer.TemplateRenderer" />
    <component-import key="ao" name="Active Objects" interface="com.atlassian.activeobjects.external.ActiveObjects" />
    <component-import key="applicationProperties" interface="com.atlassian.sal.api.ApplicationProperties" />
    <component-import key="pluginSettingsFactory" interface="com.atlassian.sal.api.pluginsettings.PluginSettingsFactory" />
    <component-import key="requestFactory" interface="com.atlassian.sal.api.net.RequestFactory" />
    <component-import key="i18nResolver" interface="com.atlassian.sal.api.message.I18nResolver" />
    <component-import key="webResourceManager" interface="com.atlassian.plugin.webresource.WebResourceManager" />
    <component-import key="userProfileAccessor" interface="com.atlassian.streams.spi.UserProfileAccessor" />
    <component-import key="featureManager" interface="com.atlassian.jira.config.FeatureManager" system="true" />
    <component-import key="eventPublisher" interface="com.atlassian.event.api.EventPublisher" />


    <ao key="ao-module" name="Active Objects Module">
        <!-- TODO remove the next two lines when possible -->
        <entity>com.atlassian.jira.plugins.bitbucket.activeobjects.v2.ProjectMapping</entity>
        <entity>com.atlassian.jira.plugins.bitbucket.activeobjects.v2.IssueMapping</entity>
        
        <entity>com.atlassian.jira.plugins.dvcs.activeobjects.v3.OrganizationMapping</entity>
        <entity>com.atlassian.jira.plugins.dvcs.activeobjects.v3.RepositoryMapping</entity>
        <entity>com.atlassian.jira.plugins.dvcs.activeobjects.v3.ChangesetMapping</entity>
        <upgradeTask>com.atlassian.jira.plugins.bitbucket.activeobjects.PropertyMigrator</upgradeTask>
        <upgradeTask>com.atlassian.jira.plugins.bitbucket.activeobjects.Uri2UrlMigrator</upgradeTask>
        <upgradeTask>com.atlassian.jira.plugins.bitbucket.activeobjects.v2.To_04_ActiveObjectsV2Migrator</upgradeTask>
        <upgradeTask>com.atlassian.jira.plugins.bitbucket.activeobjects.v2.To_05_RepositoryTypeMigrator</upgradeTask>
        <upgradeTask>com.atlassian.jira.plugins.bitbucket.activeobjects.v2.To_06_GithubRepositories</upgradeTask>
        <upgradeTask>com.atlassian.jira.plugins.bitbucket.activeobjects.CleanupPluginSettings</upgradeTask>
        <upgradeTask>com.atlassian.jira.plugins.dvcs.activeobjects.v3.To_08_ActiveObjectsV3Migrator</upgradeTask>
    </ao>

    <component key="executorService" name="Executor Service Factory Component"
            class="com.atlassian.jira.plugins.bitbucket.DefaultExecutorServiceFactoryBean">
        <description>ExecutorService factory bean for creating executor services</description>
        <interface>com.atlassian.jira.plugins.bitbucket.ExecutorServiceFactoryBean</interface>
    </component>

    <component key="issueLinker" name="issueLinker"
            class="com.atlassian.jira.plugins.bitbucket.IssueLinkerImpl">
        <interface>com.atlassian.jira.plugins.bitbucket.api.IssueLinker</interface>
    </component>

    <component key="responseHandlerFactory" name="responseHandlerFactory"
            class="com.atlassian.jira.plugins.bitbucket.api.net.DefaultExtendedResponseHandlerFactory">
        <interface>com.atlassian.jira.plugins.bitbucket.api.net.ExtendedResponseHandlerFactory</interface>
    </component>

    <component key="repositoryPersister" name="Repository Persister"
               class="com.atlassian.jira.plugins.bitbucket.api.impl.DefaultRepositoryPersister">
        <description>A Service for storing data in ActiveObjects</description>
        <interface>com.atlassian.jira.plugins.bitbucket.api.ChangesetCache</interface>
        <interface>com.atlassian.jira.plugins.bitbucket.api.RepositoryPersister</interface>
    </component>

    <!--TODO refaktorovat zavyslost na RepoManager-->
    <!--<component key="synchronizer" name="Bitbucket Synchronization Service"-->
               <!--class="com.atlassian.jira.plugins.bitbucket.DefaultSynchronizer">-->
        <!--<description>A Service for migrating from the property set storage to ActiveObjects</description>-->
        <!--<interface>com.atlassian.jira.plugins.bitbucket.api.Synchronizer</interface>-->
    <!--</component>-->

    <component key="bitbucketProjectSettings" name="Bitbucket Project Settings Component"
               class="com.atlassian.jira.plugins.bitbucket.activeobjects.DefaultBitbucketProjectSettings">
        <description>A facade for storing project settings</description>
        <interface>com.atlassian.jira.plugins.bitbucket.activeobjects.BitbucketProjectSettings</interface>
    </component>

    <!--<component key="globalRepositoryManager" name="globalRepositoryManager"-->
               <!--class="com.atlassian.jira.plugins.bitbucket.GlobalRepositoryManager">-->
        <!--<description>globalRepositoryManager</description>-->
        <!--<interface>com.atlassian.jira.plugins.bitbucket.api.RepositoryManager</interface>-->
    <!--</component>-->

    <!--<component key="githubRepositoryManager" name="githubRepositoryManager"-->
               <!--class="com.atlassian.jira.plugins.bitbucket.spi.github.GithubRepositoryManager">-->
        <!--<description>githubRepositoryManager</description>-->
        <!--<interface>com.atlassian.jira.plugins.bitbucket.api.RepositoryManager</interface>-->
    <!--</component>-->



    <component key="encryptor" name="Encryption Service"
               class="com.atlassian.jira.plugins.dvcs.crypto.DefaultEncryptor">
        <description>A service for encrypting and decrypting passwords</description>
        <interface>com.atlassian.jira.plugins.dvcs.crypto.Encryptor</interface>
    </component>


    <component key="authenticationFactory" name="Authentication Factory"
               class="com.atlassian.jira.plugins.dvcs.auth.impl.DefaultAuthenticationFactory">
        <description>Creating authenticators</description>
        <interface>com.atlassian.jira.plugins.dvcs.auth.AuthenticationFactory</interface>
    </component>

    <component key="requestHelper" name="requestHelper"
            class="com.atlassian.jira.plugins.dvcs.net.DefaultRequestHelper">
        <interface>com.atlassian.jira.plugins.dvcs.net.RequestHelper</interface>
    </component>

    <component key="bitbucketCommunicator" name="bitbucketCommunicator"
               class="com.atlassian.jira.plugins.dvcs.spi.bitbucket.BitbucketCommunicator">
        <description>bitbucketCommunicator</description>
        <interface>com.atlassian.jira.plugins.dvcs.service.remote.DvcsCommunicator</interface>
    </component>

    <component key="githubCommunicator" name="githubCommunicator"
               class="com.atlassian.jira.plugins.dvcs.spi.github.GithubCommunicator">
        <description>githubCommunicator</description>
        <interface>com.atlassian.jira.plugins.dvcs.service.remote.DvcsCommunicator</interface>
    </component>

    <component key="dvcsCommunicatorProvider" name="dvcsCommunicatorProvider"
               class="com.atlassian.jira.plugins.dvcs.service.remote.DvcsCommunicatorProvider">
        <description>dvcsCommunicatorProvider</description>
    </component>

    <component key="githubOAuth" name="githubOAuth"
               class="com.atlassian.jira.plugins.dvcs.spi.github.DefaultGithubOAuth">
        <description>githubOAuth</description>
        <interface>com.atlassian.jira.plugins.dvcs.spi.github.GithubOAuth</interface>
    </component>

    <component key="organizationDao" name="organizationDao"
               class="com.atlassian.jira.plugins.dvcs.dao.impl.OrganizationDaoImpl">
        <description>organizationDao</description>
        <interface>com.atlassian.jira.plugins.dvcs.dao.OrganizationDao</interface>
    </component>

    <component key="repositoryDao" name="repositoryDao"
               class="com.atlassian.jira.plugins.dvcs.dao.impl.RepositoryDaoImpl">
        <description>repositoryDao</description>
        <interface>com.atlassian.jira.plugins.dvcs.dao.RepositoryDao</interface>
    </component>


    <component key="organizationService" name="organizationService"
               class="com.atlassian.jira.plugins.dvcs.service.OrganizationServiceImpl">
        <description>organizationService</description>
        <interface>com.atlassian.jira.plugins.dvcs.service.OrganizationService</interface>
    </component>

    <component key="repositoryService" name="repositoryService"
               class="com.atlassian.jira.plugins.dvcs.service.RepositoryServiceImpl">
        <description>repositoryService</description>
        <interface>com.atlassian.jira.plugins.dvcs.service.RepositoryService</interface>
    </component>

    <component key="changesetService" name="changesetService"
               class="com.atlassian.jira.plugins.dvcs.service.ChangesetServiceImpl">
        <description>changesetService</description>
        <interface>com.atlassian.jira.plugins.dvcs.service.ChangesetService</interface>
    </component>
    
    
    <!-- Listener -->
    <component key="dvcsAddUserListener" class="com.atlassian.jira.plugins.dvcs.listener.DvcsAddUserListener" />

    <issue-tabpanel key="bitbucket-commits-tabpanel" name="BitBucket Changesets Tab Panel"
                    class="com.atlassian.jira.plugins.bitbucket.webwork.BitbucketTabPanel">

        <description>Show Bitbucket changesets related to an issue in an issue tab panel.</description>
        <label>Commits</label>
        <resource type="velocity" name="view" location="templates/com/tsc/jira/github/issuetabpanels/view.vm"/>
        <supports-ajax-load>true</supports-ajax-load>
    </issue-tabpanel>

    <!-- The webwork1 plugin element is how you add new actions to JIRA -->
    <webwork1 key="repositoryConfiguration" name="Repository Configuration" class="java.lang.Object">
        <!-- Note that HTML in the description element is ignored -->
        <description>
        </description>
        <actions>
        
        	<action name="com.atlassian.jira.plugins.dvcs.webwork.ConfigureDvcsOrganizations"
                    alias="ConfigureDvcsOrganizations" roles-required="admin">
                <view name="input">/templates/dvcs/add-organization.vm</view>
            </action>

            <action name="com.atlassian.jira.plugins.bitbucket.webwork.ConfigureBitbucketRepositories"
                    alias="ConfigureBitbucketRepositories" roles-required="admin">
                <view name="input">/templates/configurerepositories.vm</view>
            </action>

	        <action name="com.atlassian.jira.plugins.bitbucket.spi.github.webwork.AddGithubRepository" alias="AddGithubRepository">
	            <view name="input">/templates/addgithubrepository.vm</view>
	        </action>

	        <action name="com.atlassian.jira.plugins.bitbucket.spi.bitbucket.webwork.AddBitbucketRepository" alias="AddBitbucketRepository">
	            <view name="input">/templates/addbitbucketrepository.vm</view>
	        </action>

            <action name="com.atlassian.jira.plugins.dvcs.spi.github.webwork.ConfigureGithubOAuth" alias="ConfigureGithubOAuth">
                <view name="input">/templates/configuregithuboauth.vm</view>
            </action>

            <!-- these actions are  here for backward compatibility -->
            <action name="com.atlassian.jira.plugins.bitbucket.webwork.BitbucketPostCommit" alias="BitbucketPostCommit">
                <view name="postcommit">/templates/postcommit.vm</view>
            </action>
	        <action name="com.atlassian.jira.plugins.bitbucket.webwork.GithubPostCommit" alias="GitHubPostCommit">
                <view name="postcommit">/templates/postcommit.vm</view>
            </action>
            <action name="com.atlassian.jira.plugins.bitbucket.webwork.GitHubOAuth2" alias="GitHubOAuth2">
                <view name="success">/templates/githuboauth2.vm</view>
            </action>


			<!-- New organization driven actions -->
			
			<action name="com.atlassian.jira.plugins.dvcs.webwork.ConfigureDvcsOrganizations"
                    alias="ConfigureDvcsOrganizations" roles-required="admin">
                <view name="input">/templates/dvcs/add-organization.vm</view>
            </action>
            
            <action name="com.atlassian.jira.plugins.dvcs.spi.github.webwork.AddGithubOrganization"
                    alias="AddGithubOrganization" roles-required="admin">
                <view name="input">/templates/dvcs/add-github-organization.vm</view>
            </action>
            
            <action name="com.atlassian.jira.plugins.dvcs.spi.bitbucket.webwork.AddBitbucketOrganization"
                    alias="AddBitbucketOrganization" roles-required="admin">
                <view name="input">/templates/dvcs/add-bitbucket-organization.vm</view>
            </action>
           
            <action name="com.atlassian.jira.plugins.dvcs.spi.bitbucket.webwork.UpdateBitbucketCredentials"
                    alias="UpdateBitbucketCredentials" roles-required="admin">
                <view name="input">/templates/dvcs/update-bitbucket-password.vm</view>
            </action>
            
			
        </actions>
    </webwork1>

    <project-operation key="com.atlassian.jira.plugins.projectlink" name="Bitbucket Project Link"
                       class="com.atlassian.jira.plugins.bitbucket.webwork.ProjectSettings">
        <resource type="velocity" name="view" location="/templates/com/atlassian/jira/plugins/projectlinks/view.vm"/>
        <order>100</order>
    </project-operation>

    <web-item key="bitbucket_bulk_repo" name="Bitbucket Bulk Repository" section="admin_plugins_menu/source_control" weight="10">
        <description>Manage DVCS Repositories</description>
        <label>DVCS Repositories</label>
        <name>DVCS Name Item</name>

        <link>/secure/admin/ConfigureDvcsOrganizations!default.jspa</link>
        <condition class="com.atlassian.jira.plugin.webfragment.conditions.UserLoggedInCondition"/>
    </web-item>

    <web-item key="github_oauth" name="GitHub OAuth" section="admin_plugins_menu/source_control" weight="10">
        <description>Static link to github.com.</description>
        <label>GitHub OAuth Settings</label>
        <name>GitHub Name Item</name>
        <link>/secure/admin/ConfigureGithubOAuth!default.jspa</link>
        <condition class="com.atlassian.jira.plugin.webfragment.conditions.UserLoggedInCondition" />
    </web-item>

    <web-resource name="resources" key="resources">
        <resource type="download" name="javascripts/bitbucket.js" location="javascripts/bitbucket.js"/>
        <resource type="download" name="javascripts/validation.js" location="javascripts/validation.js"/>
	    <resource type="download" name="css/styles.css" location="css/styles.css" />
        <context>com.atlassian.jira.plugins.jira-bitbucket-connector-plugin</context>
    </web-resource>

    <rest key="bitbucket-rest-resources" path="/bitbucket" version="1.0">
        <description>REST Resources</description>
    </rest>

    <resource type="download" name="images/" location="images/"/>
 
    <resource type="i18n" name="bitbucket-i18n" location="i18n"/>

    <!--TODO: refaktorovat zavyslost na RepoManager-->
    <!--<activity-streams-provider key="bitbucket-streams-provider" name="Bitbucket Streams Provider" i18n-name-key="Bitbucket Connector"-->
                       <!--class="com.atlassian.jira.plugins.bitbucket.streams.BitbucketStreamsActivityProvider">-->
    <!--</activity-streams-provider>-->

	<!-- Web Panels -->
	<web-panel key="add-user-dvcs-extension" location="webpanels.admin.adduser" class="com.atlassian.jira.plugins.dvcs.adduser.AddUserDvcsExtensionWebPanel" />

 
</atlassian-plugin>