
<html>
  <head>
    <title>
        #if ($action.getMode() == 'single')
            Manage DVCS Repositories for $action.getProjectKey()
        #else
            Manage DVCS Repositories
        #end
    </title>

    <script type="text/javascript">
        var BASE_URL = "${baseurl}";

        function init_repositories()
        {
            #if ($action.nextAction == 'ForceSync')
                forceSync($action.getRepositoryId());
            #end
            retrieveSyncStatus();
            AJS.$("#repoEntry").submit(submitFunction);
        }
     </script>

    <meta name="admin.active.section" content="admin_plugins_menu/source_control"/>
    <meta name="admin.active.tab" content="bitbucket_bulk_repo"/>
  </head>

  <body>
        <input type="hidden" id="addedRepositoryId" value="$action.getAddedRepositoryId()">

 		<h3>Manage DVCS Repositories</h3>

        #if ($action.isOnDemandLicense())
            <p>Connect your <a href="http://confluence.atlassian.com/display/AOD/Linking+a+bitbucket+or+GitHub+repository+with+JIRA+OnDemand" target="_blank">Bitbucket and GitHub repo to JIRA OnDemand</a> and link every commit with a bug or development task. Once configured, JIRA will query the repository searching commits for issue keys.</p>
        #else
            <p>Connect your <a href="http://confluence.atlassian.com/display/BITBUCKET/Using+the+JIRA+DVCS+Connector+Plugin" target="_blank">Bitbucket and GitHub repo to JIRA</a> and link every commit with a bug or development task. Once configured, JIRA will query the repository searching commits for issue keys.</p>
        #end
        <br/>

        <input class="aui-button submit" id="linkRepositoryButton" type="button" title="Link a Bitbucket or GitHub organization &gt;&gt;" onclick="showAddRepoDetails(true)" value="Link a Bitbucket or GitHub organization &gt;&gt;" />

        <div id="addRepositoryContent">
            <div id="addRepositoryDetails" class="aui-message">
            <span class="svg-icon close size-16 customClose" onclick="showAddRepoDetails(false);"></span>

            <h4 style="margin: 0px;">Add new Organization</h4>

            #foreach ($errorMessage in $action.getErrorMessages())
                <div class="aui-message error shadowed">
                    <p class="title">
                        <span class="aui-icon icon-error"></span>
                        <strong>Error!</strong>
                    </p>
                    <p>$errorMessage</p>
                </div>
            #end

            <form class="aui top-label" id="repoEntry" method="post">

                <input type="hidden" name="atl_token" id="atl_token" value="$atl_token">
                <input type="hidden" name="isPrivate" id="isPrivate">
                
                <div class="field-group">
                   <label for="organizationType">Type:</label>
	               <select id="organizationType" name="organizationType" class="select" onchange="switchDvcsDetails(this)">
	               		<option vlaue="B">BitBucket</option>
	                	<option vlaue="G">GitHub</option>
	               </select>
	            </div>
				
				<div id="bitbucket-form-section">
	                <div class="field-group">
	                   <label for="organization">BB Organization:</label>
	                   <input type="text" id="organization" name="organization" value=""/>
	                </div>
	                
	                <div class="field-group">
	                   <label for="organization">Secret:</label>
	                   <input type="text" id="secret" name="secret" value=""/>
	                </div>
	                
	            </div>

				<div id="github-form-section" style="display:none">
	                <div class="field-group">
	                   <label for="organization">GH Organization:</label>
	                   <input type="text" id="organization" name="organization" value=""/>
	                </div>
	                
	                <div class="field-group">
	                   <label for="organization">Secret:</label>
	                   <input type="text" id="secret" name="secret" value=""/>
	                </div>
	            </div>
	            
	            <div style="margin-top: 10px;">
	                <input type="checkbox" id="autoLinking" name="autoLinking" class="checkbox" value=""/>
	                <label for="autoLinking">Auto link new repositories</label>
	                <div>
	                	Configure new repos to automatically link issue keys and commit messages on Bitbucket.
	            	</div>
	            </div>
     
                <div id="bbCredentials"></div>


                <div id="aui-message-bar"></div>

                <div class="buttons-container">
                    <div class="buttons">
                        <input class="button submit" type="submit" name="Submit" id="Submit" value="Add Organization" />
                        <a class="cancel" href="#" onclick="showAddRepoDetails(false)">Cancel</a>
                    </div>
                </div>
            </form>
        </div>
        </div>

        #macro ( repositoryLineItem $projectName $projectKey )
            #set($encodedProjectName = $textutils.htmlEncode($projectName))
            #set($projectRepositories = $action.getProjectRepositories($projectKey))
            #if ($projectRepositories.size() > 0)
                <tr> <td height="38px" colspan="3" class="gh_table_td_pname">
                    <span class="gh_table_project_name">$encodedProjectName</span><span class="gh_table_project_key">($projectKey)</span>
                </td> </tr>
            #end
            #foreach ($repository in $projectRepositories)

                    #set($repositoryId = $repository.getId())
                    #set($encodedProjectKey = $textutils.htmlEncode($action.getProjectKey()))
                    #set($encodedMode = $textutils.htmlEncode($action.getMode()))
                    <tr>
                        #if ($repository.getRepositoryType() == 'bitbucket')
                            #set($repoTypeImgName = "bitbucket")
                        #else
                            #set($repoTypeImgName = "github")
                        #end
                        <td width="1px" height="40px">
                            <span class="$repository.getRepositoryType()Logo">&nbsp;</span>
                            </td>
                        <td><a class="repositoryNameLink" href="$textutils.htmlEncode($repository.repositoryUri.repositoryUrl)" target="_new">
                            <span class="repositoryName">$textutils.htmlEncode($repository.repositoryName)</span>
                        </a></td>
                        <td style="text-align: right;">
                            <span id="syncicon_$repositoryId" class="syncicon" >&nbsp;</span>
                            <span id="sync_status_message_$repositoryId" class="gh_messages">
                                <span class="content"></span> |
                            </span>

                            <a href="#" onclick="forceSync($repositoryId); AJS.$('.gh_messages.repository$repositoryId').slideDown(); return false;">Force Sync</a> |
                            <a href="#" onclick="deleteRepository($repositoryId, '$textutils.htmlEncode($repository.repositoryUri.repositoryUrl)')">Delete</a>
                        </td>
                    </tr>
                    <tr>
                        <td class="status" colspan="3">
                            <span id="sync_error_message_$repositoryId" class="gh_messages">
                            </span>
                        </td>
                    </tr>

            #end
        #end


        <table class="gh_table" cellspacing="0" cellpadding="0">
            #if ($action.getMode() == 'single')
                #repositoryLineItem($action.getProjectName() $action.getProjectKey())
            #else
                #foreach ($project in $action.getProjects())
                    #repositoryLineItem($project.name $project.key)
                #end
            #end

        </table>

  </body>
</html>