<html>
  <head>
    <title>
           Manage DVCS Repositories
    </title>

    <script type="text/javascript">
        var BASE_URL = "${baseurl}";

        function init_repositories()
        {
            #if ($action.nextAction == 'ForceSync')
                forceSync($action.getRepositoryId());
            #end
            retrieveSyncStatus();
            AJS.$("#repoEntry").submit(submitFormHandler);
        }
     </script>

    <meta name="admin.active.section" content="admin_plugins_menu/source_control"/>
    <meta name="admin.active.tab" content="bitbucket_bulk_repo"/>
  </head>

  <body>
        <input type="hidden" id="addedRepositoryId" value="$action.getAddedRepositoryId()">

 		<h3>Manage DVCS Repositories</h3>

        #if ($action.isOnDemandLicense())
            <p>Connect your <a href="http://confluence.atlassian.com/display/AOD/Linking+a+bitbucket+or+GitHub+repository+with+JIRA+OnDemand" target="_blank">Bitbucket and GitHub repo to JIRA OnDemand</a> and link every commit with a bug or development task. Once configured, JIRA will query the repository searching commits for issue keys.</p>
        #else
            <p>Connect your <a href="http://confluence.atlassian.com/display/BITBUCKET/Using+the+JIRA+DVCS+Connector+Plugin" target="_blank">Bitbucket and GitHub repo to JIRA</a> and link every commit with a bug or development task. Once configured, JIRA will query the repository searching commits for issue keys.</p>
        #end
        <br/>

        <input class="aui-button submit" id="linkRepositoryButton" type="button" title="Link a Bitbucket or GitHub organization &gt;&gt;" onclick="showAddRepoDetails(true)" value="Link a Bitbucket or GitHub organization &gt;&gt;" />

        <div id="addRepositoryContent">
        <div id="addRepositoryDetails" class="aui-message">
            <span class="svg-icon close size-16 customClose" onclick="showAddRepoDetails(false);"></span>

            <h4 style="margin: 0px;">Add new Organization</h4>

            #foreach ($errorMessage in $action.getErrorMessages())
                <div class="aui-message error shadowed">
                    <p class="title">
                        <span class="aui-icon icon-error"></span>
                        <strong>Error!</strong>
                    </p>
                    <p>$errorMessage</p>
                </div>
            #end

            <form class="aui top-label" id="repoEntry" method="post"  >

                <input type="hidden" name="atl_token" id="atl_token" value="$atl_token">
                <input type="hidden" name="isPrivate" id="isPrivate">
              
	            
	            <div class="aui-item-column1">
                    <div class="field-group" >
                      <label for="url">Url:</label>
                      <input type="text" id="url" name="repositoryUrl" value="$textutils.htmlEncode($action.getRepositoryUrl())"/>
                      <div class="fieldValue" id="urlReadOnly"></div>
                    </div>
                </div>
                <div class="aui-item-column2" id="examples">
                    <label>Examples:</label>
                    <div style="padding-top: 3px;"><i>https://bitbucket.org</i></div>
                    <div><i>https://github.com</i></div>
                </div>
                 <div>
                    <div class="field-group" >
                      <label for="organization">Organization:</label>
                      <input type="text" id="organization" name="organization" value=""/>
                      <div class="fieldValue" id="urlReadOnly"></div>
                    </div>
                 </div>
				
				<div id="bitbucket-form-section" style="display:none">
	                <div class="field-group">
	                   <label for="adminPassword">Password:</label>
	                   <input type="text" id="adminPassword" name="adminPassword" value=""/>
	                </div>
	            </div>

				<div id="github-form-section" style="display:none">
                   
	            </div>
	            
	            <div style="margin-top: 10px; clear: both" >
	                <input type="checkbox" id="autoLinking" name="autoLinking" class="checkbox" value=""/>
	                <label for="autoLinking">Auto link new repositories</label>
	                <div>
	                	Configure new repos to automatically link issue keys and commit messages on Bitbucket.
	            	</div>
	            </div>
     
                <div id="bbCredentials"></div>


                <div id="aui-message-bar"></div>

                <div class="buttons-container">
                    <div class="buttons">
                        <input class="button submit" type="submit" name="Submit" id="Submit" value="Add Organization" />
                        <a class="cancel" href="#" onclick="showAddRepoDetails(false)">Cancel</a>
                    </div>
                </div>
            </form>
        </div>
        </div>
   		
   		#printOrganizations
   		
        #macro ( repositoryLineItem $projectName $projectKey )
            #set($encodedProjectName = $textutils.htmlEncode($projectName))
            #set($projectRepositories = $action.getProjectRepositories($projectKey))
            #if ($projectRepositories.size() > 0)
                <tr> <td height="38px" colspan="3" class="gh_table_td_pname">
                    <span class="gh_table_project_name">$encodedProjectName</span><span class="gh_table_project_key">($projectKey)</span>
                </td> </tr>
            #end
            #foreach ($repository in $projectRepositories)

                    #set($repositoryId = $repository.getId())
                    #set($encodedProjectKey = $textutils.htmlEncode($action.getProjectKey()))
                    #set($encodedMode = $textutils.htmlEncode($action.getMode()))
                    <tr>
                        #if ($repository.getRepositoryType() == 'bitbucket')
                            #set($repoTypeImgName = "bitbucket")
                        #else
                            #set($repoTypeImgName = "github")
                        #end
                        <td width="1px" height="40px">
                            <span class="$repository.getRepositoryType()Logo">&nbsp;</span>
                            </td>
                        <td><a class="repositoryNameLink" href="$textutils.htmlEncode($repository.repositoryUri.repositoryUrl)" target="_new">
                            <span class="repositoryName">$textutils.htmlEncode($repository.repositoryName)</span>
                        </a></td>
                        <td style="text-align: right;">
                            <span id="syncicon_$repositoryId" class="syncicon" >&nbsp;</span>
                            <span id="sync_status_message_$repositoryId" class="gh_messages">
                                <span class="content"></span> |
                            </span>

                            <a href="#" onclick="forceSync($repositoryId); AJS.$('.gh_messages.repository$repositoryId').slideDown(); return false;">Force Sync</a> |
                            <a href="#" onclick="deleteRepository($repositoryId, '$textutils.htmlEncode($repository.repositoryUri.repositoryUrl)')">Delete</a>
                        </td>
                    </tr>
                    <tr>
                        <td class="status" colspan="3">
                            <span id="sync_error_message_$repositoryId" class="gh_messages">
                            </span>
                        </td>
                    </tr>

            #end
        #end


		#*

        <table class="gh_table" cellspacing="0" cellpadding="0">
            #if ($action.getMode() == 'single')
                #repositoryLineItem($action.getProjectName() $action.getProjectKey())
            #else
                #foreach ($project in $action.getProjects())
                    #repositoryLineItem($project.name $project.key)
                #end
            #end

        </table>
        
        *#
	
	#printUpdateCredentialsFormHidden
	
  </body>
</html>

############################################################################
## macros needs to be here as : 
## velocimacro.permissions.allow.inline.local.scope = true
## and we cannot affect velocimacro.library
############################################################################
#macro (printOrganizations)

<div class="vert-space">&nbsp;</div>

<h4 class="aui">Organization: sample-org (BibBucket)</h4>
	
	<div class="dvcs-organization-controls"><input class="aui" type="checkbox" name="autolink-quick" /><label> Autolink new repositories</label>
	 | <a href="javascript:;">Sync Repository List</a>
	 | <a href="javascript:changePassword();">Change Password</a>
	 | <a href="javascript:;">Delete organization</a>
	</div>
	<div class="vert-space">&nbsp;</div>

   <div>
     
   <table class="aui">
    <thead>
        <tr>
            <th>Repository</th>
            <th>Enable Linking</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>some-repo</td>
            <td><input type="checkbox"></td>
            <td class="action" headers="action">
                <ul class="menu">
                    <li>
                        <a href="javascript:;">Sync Repo</a>
                    </li>
                </ul>
            </td>
        </tr>
       
        <tr>
            <td>some-repo-2</td>
            <td><input type="checkbox"></td>
            <td class="action" headers="action">
                <ul class="menu">
                    <li>
                        <a href="#">Sync Repo</a>
                    </li>
                </ul>
            </td>
        </tr>
       
    </tbody>
</table>
#end

#macro (printUpdateCredentialsFormHidden)
	
	<div class="update-credentials" style="display:none">
		<form class="aui" method="post">
			 <div class="field-group">
		           <label for="organization">Organization:</label>
		           <input type="text" id="organizationUp" name="organizationUp" value=""/>
		     </div>
		                
		     <div class="field-group">
		          <label for="adminPasswordUp">Password:</label>
		          <input type="text" id="adminPasswordUp" name="adminPasswordUp" value=""/>
		     </div>
		</form>
	</div>

#end

