<html>
  <head>
    <title>
        #if ($action.getMode() == 'single')
            Bitbucket Repositories
        #else
            Bulk Configure Bitbucket Repositories
        #end
    </title>

    <script type="text/javascript">
        var BASE_URL = "${baseurl}"
        function init_repositories()
        {
            #if ($action.nextAction == 'ForceSync')
                forceSync($action.getRepositoryId());
                AJS.$('.gh_messages.repository$action.getRepositoryId()').slideDown()
            #end
            retrieveSyncStatus();
            
            AJS.$("#addPostCommitService").click(function(a){
                AJS.$("#postCommitServiceDetails").slideToggle()
                console.log(a)
                });
        }            
     </script>

        <style type="text/css">


        #gh_config_link{
            margin-top: 10px;
        }

        #gh_config_link a{
            background: url('${baseurl}/download/resources/com.atlassian.jira.plugins.jira-bitbucket-connector-plugin/images/pencil_icon.jpg');
            background-repeat: no-repeat;
            background-position: right center;
            padding-right: 20px;
            font-size: 10pt;
        }

        .gh_config_h4{
            font-weight: normal;
            color: #3676B7;
            background: url('${baseurl}/download/resources/com.atlassian.jira.plugins.jira-bitbucket-connector-plugin/images/down_gray_arrow.jpg');
            background-repeat: no-repeat;
            background-position: left center;
            padding-left: 18px;
            margin-top: 18px;
        }

        #gh_post_receive_header{
            font-weight: normal;
            font-size: 10pt;
            color: #666;
            margin-top: 18px;
            margin-bottom: 10px;
        }

        #gh_post_receive_textbox{
            font-size: 10pt;
            padding: 4px;
        }

        #gh_post_receive{
            margin-bottom: 10px;
        }

        .gh_table{
            margin-left: 16px;
            width: 100%
        }

        .gh_table_project_name{
            font-size: 10pt;
            color: #5F6262;
            padding-top: 14px;
        }

        .gh_table th{
            font-weight: normal;
            color: #656565;
            border-bottom: 1px solid #cccccc;
            font-size: 10pt;
        }

        .gh_table td.status{
            border-bottom: 1px solid #cccccc;
            font-size: 10pt;
            padding:0 20px;
        }
        .gh_table td.status .error{
            color:#f66;
        }
        
        .gh_table td{
            font-size: 10pt;
        }

        .gh_table_td_pname{
            border-bottom: none !important;
        }

        #gh_example_link{
            font-size: 6pt;
        }

        #gh_submit{
            font-size: 8pt;
        }

        .gh_messages{
            font-size: 10pt;
            color: #666;
            font-style: italic;
        }

        .form {
            margin:20px;
            background-color: #B9E6F0;
            padding: 20px;
            
            -moz-border-radius: 6px;
            -webkit-border-radius: 6px;
            -khtml-border-radius: 6px;
            border-radius: 6px;            
        }
        
        .syncicon {
            cursor: pointer;
            width:16px;
            display:inline-block;
            background-image: url(http://www.businessfbpage.com/wp-content/plugins/pricing-table/images/info.gif)
        }

        .syncicon.error {
            background-image: url(http://confluence.jetbrains.net/download/attachments/24091/error.gif?version=1&modificationDate=1174560837000)
        }

        .syncicon.running {
            background-image: url(http://avacomglobal.com/images/working.gif)
        }

        .syncicon.finished {
            background-image: url(http://drupal.org/files/issues/status-ok.png)
        }
        label {
            font-weight:bold;
        }
        .postCommitServiceDetails {
            display:none;
        }
        .postCommitServiceDetails input {
            float:right;
        }
        .postCommitServiceDetails label {
            float:left;
        }
        .postCommitServiceDetails div{
            width: 200px;
        }


    </style>

  </head>

  <body>
            ## used in func tests
            #if ($action.nextAction == 'ForceSync')
                <input type="hidden" id="addedRepositoryId" value="$action.getRepositoryId()">
            #end

    
    
 		<h3>
            #if ($action.getMode() == 'single')
                Existing Repositories Linked to $textutils.htmlEncode($action.getProjectName())
            #else
                Bulk Configure Bitbucket Repositories
            #end
 		</h3>


            <h4 class="gh_config_h4">Existing Linked Repositories</h4>

            <table class="gh_table" cellspacing="0" cellpadding="4">

            #macro ( repositoryLineItem $projectName $projectKey )
                #set($encodedProjectName = $textutils.htmlEncode($projectName))
                <tr> <td colspan="3" class="gh_table_td_pname"><div class="gh_table_project_name">$encodedProjectName</div></td> </tr>
                <tr> <th>Repository URL</th> <th>Key</th> <th>Operations</th> </tr>
                #foreach ($repository in $action.getProjectRepositories($projectKey))
                    #set($repositoryId = $repository.getId())
                    #set($encodedProjectKey = $textutils.htmlEncode($action.getProjectKey()))
                    #set($encodedMode = $textutils.htmlEncode($action.getMode()))
                    <tr>
                        <td><a href="$textutils.htmlEncode($repository.repositoryUri.repositoryUrl)" target="_new">$textutils.htmlEncode($repository.repositoryUri.repositoryUrl)</a></td>
                        <td>$projectKey</td>
                        <td width="260px">
                            <span title="Show/Hide info about syncing" class="syncicon repository$repositoryId" onclick="AJS.$('.gh_messages.repository$repositoryId').slideToggle()">&nbsp;</span>
                            <a href="#" onclick="forceSync($repositoryId); AJS.$('.gh_messages.repository$repositoryId').slideDown(); return false;">Force Sync</a> |
                            <a href="${baseurl}/secure/admin/ConfigureBitbucketRepositories.jspa?repositoryId=$repositoryId&projectKey=$encodedProjectKey&nextAction=ShowPostCommitURL&mode=$encodedMode&atl_token=$atl_token">Post Commit</a> |
                            <a href="#" onclick="confirmation('${baseurl}/secure/admin/ConfigureBitbucketRepositories.jspa?nextAction=DeleteRepository&projectKey=$encodedProjectKey&repositoryId=$repositoryId&mode=$encodedMode&atl_token=$atl_token')">Delete</a>
                        </td>
                    </tr>
                    <tr>
                        <td class="status" colspan="3">
                        <div name="sync_status_message" class="gh_messages repository$repositoryId" style="display:none">
                        </div>
                        </td>
                    </tr>
                #end
            #end

            #if ($action.getMode() == 'single')
                #repositoryLineItem($action.getProjectName() $action.getProjectKey())
            #else
                #foreach ($project in $action.getProjects())
                    #repositoryLineItem($project.name $project.key)
                #end
            #end

            </table>

			<div class="form">
                <p>Add additional Bitbucket repositories to the projects to link their commits with JIRA issue keys.</p>

                #if ($action.getMode() == 'single')
                    Enter the Bitbucket repository URL.</p>
                #else
                    Enter the JIRA project and Bitbucket repository URL.</p>
                #end

                #if ($action.getValidations() != "")
                    <div style="margin: 10px; border: 2px solid red; width: 400px; background: #ddd; padding: 15px;">
                           <h3>$action.getValidations() </h3>
                    </div>
                #end


                #if ($action.getNextAction() == "AddRepository" && $action.getRepoVisibility() == "private")
                    <div style='margin-bottom: 12px'>

                        <form id="privateCredentialsEntry" method="post" action="${baseurl}/secure/admin/ConfigureBitbucketRepositories.jspa">
                              <input type="hidden" name="nextAction" value="AddRepository">
                              <input type="hidden" name="url" value="$textutils.htmlEncode($action.getURL())">
                              <input type="hidden" name="projectKey" value="$action.getProjectKey()">
                              <input type="hidden" name="repoVisibility" value="private">
                              <input type="hidden" name="mode" value="$textutils.htmlEncode($action.getMode())">
                              <input type="hidden" name="atl_token" value="$atl_token">
                              <table width="300px">
                                  <tr>
                                      <td colspan="2"><h3 id='gh_post_receive_header'>Bitbucket Credentials</h3></td>
                                  </tr>
                                  <tr>
                                    <td>Username</td>
								  </tr>
								  <tr>
                                    <td><input type="text" name="bbUserName"></td>
                                  </tr>

                                  <tr>
                                    <td>Password</td>
								  </tr>
								  <tr>
                                    <td><input type="password" name="bbPassword"></td>
                                  </tr>

                                  <tr>
                                    <td>
                                        <input type="submit" value="Set Credentials">
                                    </td>
                                  </tr>
                              </table>


                        </form>

                    </div>
                #end


                #if ($action.getPostCommitURL() != "")
                    <div>
                           <h3 id="gh_post_receive_header">Post-Commit Hook</h3>
                            <p>Please add the URL below as a post-commit service to the Bitbucket repository.</p>
                            <p>
								<input id="gh_post_receive_textbox" type"text" size="90" value="$action.getPostCommitURL()">
                            </p>

                    </div>
                #end

                 <form id="repoEntry" method="post" action="${baseurl}/secure/admin/ConfigureBitbucketRepositories.jspa">
                      <input type="hidden" name="nextAction" value="AddRepository">
                      <input type="hidden" name="atl_token" value="$atl_token">
                      <table>

                        <tr>
                          <td><label for="url">Repository Url</label></td>
                          <td valign='top'>
                             <input type="text"
                             id="url"
                             name="url"
                             value="$textutils.htmlEncode($action.getURL())"
                             size="60"
                             /><br/>
                          </td>
                          <td><i>eg: https://bitbucket.org/atlassianguy/my-repository</i></td>
                        </tr>  
                        <tr>  
                          <td><label for="repoVisibility">Repository visibility</label></td>
                          <td valign='top'>
                              <select name="repoVisibility" id="repoVisibility">
                                  <option value="public" #if ($action.getRepoVisibility() == 'public') selected #end >Public</option>
                                  <option value="private" #if ($action.getRepoVisibility() == 'private') selected #end >Private</option>
                              </select>
                          </td>
                        </tr>  
                        #if ($action.getMode() == 'single')
                            <input type='hidden' name='projectKey' value='$action.getProjectKey()'>
                            <input type='hidden' name='mode' value='single'>
                        #else
                        <tr>  
                          <td><label for="projectKey">Choose project</label></td>
                          <td valign='top'>
                              <select name="projectKey" id="projectKey">
                                #foreach ($project in $action.getProjects())
                                  <option value="${project.key}"#if ($action.getProjectKey() == $project.key) selected #end>$textutils.htmlEncode(${project.name})</option>
                                #end
                              </select>
                          </td>
                        </tr>  
                        #end
                        <tr>  
                          <td valign="top"><label for="addPostCommitService">Add postcomit service</label></td>
                          <td colspan="2"> 
                            <input type="checkbox" name="addPostCommitService" id="addPostCommitService">
                            <div class="postCommitServiceDetails" id="postCommitServiceDetails">
                                Installing postcommit service requires admin access to the repository.
                                <div><label for="adminUsername">Username</label><input type="text" name="adminUsername" id="adminUsername"></div>
                                <div><label for="adminPassword">Password</label><input type="password" name="adminPassword" id="adminPassword"></div>
                            </div>
                          </td>
                        </tr>  
                        <tr>
                            <td>&nbsp;</td><td></td>
                        </tr>  
                        <tr>  
                            <td valign='top'>
                                <input type="submit" name="Submit" id="Submit" value="Add Repository"/>
                            </td>
                            <td></td>
                        </tr>
                        
                      </table>
                 </form>

             </div>
  </body>
</html>