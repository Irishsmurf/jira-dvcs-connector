<html>
  <head>
    <title>
        #if ($action.getMode() == 'single')
            Bitbucket Repositories
        #else
            Bulk Configure Bitbucket Repositories
        #end
    </title>

    <script type="text/javascript">

        // Function is located in velocity template not the global bitbucket.js include as
        // we need to dynamically insert URLs
        function forceSync(url, projectKey){
            AJS.$('#gh_messages').css('display','block');
            AJS.$('#connector_sync_message').html("");
            AJS.$('#connector_sync_status').html("");

            AJS.$('#connector_sync_message').load('$action.getBaseURL()/ConfigureBitbucketRepositories.jspa?nextAction=SyncRepository&url=' + url + '&projectKey=' + projectKey);

            console.log('url ' +  '/secure/admin/ConfigureBitbucketRepositories.jspa?nextAction=SyncRepository&url=' + url + '&projectKey=' + projectKey);

            window.setInterval(function(){
                AJS.$('#connector_sync_status').load('$action.getBaseURL()/ConfigureBitbucketRepositories.jspa?nextAction=CurrentSyncStatus&url=' + url + '&projectKey=' + projectKey);
            }, 1000);
        }

        var url = '$action.getURL()';
        var projectKey = '$action.getProjectKey()';

    </script>

    <style type="text/css">


        #gh_config_link{
            margin-top: 10px;
        }

        #gh_config_link a{
            background: url('$action.getBaseURL()/download/resources/com.atlassian.jira.plugins.bitbucket.Bitbucket/images/pencil_icon.jpg');
            background-repeat: no-repeat;
            background-position: right center;
            padding-right: 20px;
            font-size: 8pt;
        }

        .gh_config_h4{
            font-weight: normal;
            color: #3676B7;
            background: url('$action.getBaseURL()/download/resources/com.atlassian.jira.plugins.bitbucket.Bitbucket/images/down_gray_arrow.jpg');
            background-repeat: no-repeat;
            background-position: left center;
            padding-left: 18px;
            margin-top: 18px;
        }

        #gh_post_receive_header{
            font-weight: normal;
            font-size: 10pt;
            color: #666;
            margin-top: 18px;
            margin-bottom: 10px;
        }

        #gh_post_receive_textbox{
            font-size: 6pt;
            padding: 4px;
        }

        #gh_post_receive{
            margin-bottom: 10px;
        }

        .gh_table{
            margin-left: 16px;
            width: 100%
        }

        .gh_table_project_name{
            font-size: 10pt;
            color: #5F6262;
            padding-top: 14px;
        }

        .gh_table th{
            font-weight: normal;
            color: #656565;
            border-bottom: 1px solid #cccccc;
            font-size: 8pt;
        }

        .gh_table td{
            border-bottom: 1px solid #cccccc;
            font-size: 8pt;
        }

        .gh_table_td_pname{
            border-bottom: none !important;
        }

        .gh_instructions{
            margin-left: 18px;
			margin-top: 12px;
            font-size: 8pt;
            color: #656565;
        }

        #gh_example_link{
            font-size: 6pt;
        }

        #repoEntry select{
            font-size: 8pt;
        }

        #repoEntry input{
            font-size: 6pt;
            padding: 4px;
        }

        #gh_submit{
            font-size: 8pt;
        }

        #gh_messages{
            background-color: #DFEFFE;
            margin-left: 18px;
            margin-top: 18px;
			margin-bottom: 20px;
            border: 2px solid #bbb;
            padding: 10px;
            padding-left: 36px;
            -moz-border-radius: 6px;
            -webkit-border-radius: 6px;
            -khtml-border-radius: 6px;
            border-radius: 6px;
            background-image: url('$action.getBaseURL()/download/resources/com.atlassian.jira.plugins.bitbucket.Bitbucket/images/blue_info_icon.jpg');
            background-repeat: no-repeat;
            background-position: 10px 10px;
            font-size: 8pt;
        }

        #gh_messages h2{
            font-size: 8pt;
            color: #333;
        }

    </style>






  </head>

  <body>

 		<h3>
            #if ($action.getMode() == 'single')
                Existing Repositories Linked to $action.getProjectName()
            #else
                Bulk Configure Bitbucket Repositories
            #end
 		</h3>


            <h4 class="gh_config_h4">Existing Linked Repositories</h4>

            <table class="gh_table" cellspacing="0" cellpadding="4">


                #foreach ($project in $action.getProjects())
                    #if ($action.getProjectRepositories($project.key))

                        <tr>
                            <th colspan="3" style="text-transform: uppercase;">${project.name}</th>
                        </tr>

                        <tr>
                            <th>Repository URL</th>
                            <th>Key</th>
                            <th>Operations</th>
                        </tr>

                    #end

                    #foreach ($repository in $action.getProjectRepositories($project.key))
                        <tr>
                            <td><a href="$repository" target="_new">$repository</a></td>
                            <td>$project.key</td>

                            <td width="260px">
                                <a href="$action.getBaseURL()/secure/admin/ConfigureBitbucketRepositories.jspa?url=$repository&projectKey=$project.key&nextAction=ForceSync&mode=$action.getMode()">Force Sync</a> |
                                <a href="$action.getBaseURL()/secure/admin/ConfigureBitbucketRepositories.jspa?url=$repository&projectKey=$project.key&nextAction=ShowPostCommitURL&mode=$action.getMode()">Post Commit</a> |
                                <a href="#" onclick="confirmation('$action.getBaseURL()/secure/admin/ConfigureBitbucketRepositories.jspa?nextAction=DeleteRepository&url=$repository&projectKey=$project.key&mode=$action.getMode()')">Delete</a>
                            </td>

                        </tr>
                    #end
                #end


            </table>

            #if ($action.nextAction == 'ForceSync')
                <div id='gh_messages' style="display: none;">
                    <h2>Sync Summary</h2>
                    <div id='connector_sync_status'></div>
                    <div id='connector_sync_message'></div>
                </div>
            #end

			<div class="gh_instructions">
                <p>Add additional Bitbucket repositories to the projects to link their commits with JIRA Issue IDs.</p>

                #if ($action.getMode() == 'single')
                    Please Enter the Bitbucket Repository URL (including branch) you would like linked.</p>
                #else
                    Please Enter the JIRA Project and Bitbucket Repository URL (including branch) you would like linked.</p>
                #end

                #if ($action.getValidations() != "")
                    <div style="margin: 10px; border: 2px solid red; width: 400px; background: #ddd; padding: 15px;">
                           <h3>$action.getValidations() </h3>
                    </div>
                #end


                #if ($action.getNextAction() == "AddRepository" && $action.getRepoVisibility() == "private")
                    <div style='margin-bottom: 12px'>

                        <form id="privateCredentialsEntry" method="post" action="$action.getBaseURL()/secure/admin/ConfigureBitbucketRepositories.jspa">
                              <input type="hidden" name="nextAction" value="AddRepository">
                              <input type="hidden" name="url" value="$action.getURL()">
                              <input type="hidden" name="projectKey" value="$action.getProjectKey()">
                              <input type="hidden" name="repoVisibility" value="private">
                              <input type="hidden" name="mode" value="$action.getMode()">
                              <table width="300px">

                                  <tr>
                                      <td colspan="2"><h3 id='gh_post_receive_header'>Bitbucket Credentials</h3></td>
                                  </tr>


                                  <tr>
                                    <td>Username</td>
								  </tr>
								  <tr>
                                    <td><input type="text" name="bbUserName"></td>
                                  </tr>

                                  <tr>
                                    <td>Password</td>
								  </tr>
								  <tr>
                                    <td><input type="password" name="bbPassword"></td>
                                  </tr>

                                  <tr>
                                    <td>
                                        <input type="submit" value="Set Credentials">
                                    </td>
                                  </tr>
                              </table>


                        </form>

                    </div>
                #end


                #if ($action.getPostCommitURL() != "")
                    <div>
                           <h3 id="gh_post_receive_header">Add a Post-Commit Hook</h3>

                            <p>Please add the URL below to your Bitbucket Repository's Services Integration </p>

                            <p>
								<input id="gh_post_receive_textbox" type"text" size="90" value="$action.getBaseURL()/$action.getPostCommitURL()">
                            </p>

                    </div>
                #end

                 <form id="repoEntry" method="post" action="$action.getBaseURL()/secure/admin/ConfigureBitbucketRepositories.jspa">
                      <input type="hidden" name="nextAction" value="AddRepository">
                      <table width="500px">

                        <tr>
                          <td valign='top'>

                                #if ($action.getMode() == 'single')
                                    <input type='hidden' name='projectKey' value='$action.getProjectKey()'>
                                    <input type='hidden' name='mode' value='single'>
                                #else

                                      <select name="projectKey">
                                        #foreach ($project in $action.getProjects())
                                          <option value="${project.key}"#if ($action.getProjectKey() == $project.key) selected #end>${project.name}</option>
                                        #end
                                      </select>
                                #end
                          </td>

                          <td valign='top'>
                              <select name="repoVisibility" id="repoVisibility">
                                  <option value="public" #if ($action.getRepoVisibility() == 'public') selected #end >Public</option>
                                  <option value="private" #if ($action.getRepoVisibility() == 'private') selected #end >Private</option>
                              </select>
                          </td>

                          <td valign='top'>
                             <input type="text"
                             id="url"
                             name="url"
                             value="$action.getURL()"
                             size="60"
                             /><br/>
							<span id="gh_example_link"><strong>Example:</strong> https://bitbucket.org/atlassianguy/my-repository/default</span>

                          </td>

                            <td class="" valign='top'>
                                <input type="submit" name="Submit" id="Submit" value="Add Repository"/>
                            </td>
                        </tr>


                      <table>
                 </form>

             </div>


  </body>
</html>