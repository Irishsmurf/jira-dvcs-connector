<html>
  <head>
    <title>
        #if ($action.getMode() == 'single')
            Bitbucket Repositories
        #else
            Bulk Configure Bitbucket Repositories
        #end
    </title>

    <script type="text/javascript">

        var repositoryId = '$action.getRepositoryId()';

        // Function is located in velocity template not the global bitbucket.js include as
        // we need to dynamically insert URLs
        var syncComplete = [];
        
        function forceSync(repositoryId){

            syncComplete[repositoryId] = false;
            AJS.$('.gh_messages.repository'+repositoryId).css('display','block');
            AJS.$('.gh_messages.repository'+repositoryId+' .sync_status').html("");
            AJS.$('.gh_messages.repository'+repositoryId+' .sync_status').load('${baseurl}/ConfigureBitbucketRepositories.jspa?nextAction=SyncRepository&repositoryId=' + repositoryId + '&atl_token=$atl_token');
        
            var int = window.setInterval(function(){
                if(syncComplete[repositoryId] == true) 
                {
                    window.clearInterval(int);
                    return;
                }
                AJS.$('.gh_messages.repository'+repositoryId+' .sync_status').load('${baseurl}/ConfigureBitbucketRepositories.jspa?nextAction=CurrentSyncStatus&repositoryId=' + repositoryId + '&atl_token=$atl_token');
            }, 1000);
        }

    </script>

    <style type="text/css">


        #gh_config_link{
            margin-top: 10px;
        }

        #gh_config_link a{
            background: url('${baseurl}/download/resources/com.atlassian.jira.plugins.jira-bitbucket-connector-plugin/images/pencil_icon.jpg');
            background-repeat: no-repeat;
            background-position: right center;
            padding-right: 20px;
            font-size: 10pt;
        }

        .gh_config_h4{
            font-weight: normal;
            color: #3676B7;
            background: url('${baseurl}/download/resources/com.atlassian.jira.plugins.jira-bitbucket-connector-plugin/images/down_gray_arrow.jpg');
            background-repeat: no-repeat;
            background-position: left center;
            padding-left: 18px;
            margin-top: 18px;
        }

        #gh_post_receive_header{
            font-weight: normal;
            font-size: 10pt;
            color: #666;
            margin-top: 18px;
            margin-bottom: 10px;
        }

        #gh_post_receive_textbox{
            font-size: 10pt;
            padding: 4px;
        }

        #gh_post_receive{
            margin-bottom: 10px;
        }

        .gh_table{
            margin-left: 16px;
            width: 100%
        }

        .gh_table_project_name{
            font-size: 10pt;
            color: #5F6262;
            padding-top: 14px;
        }

        .gh_table th{
            font-weight: normal;
            color: #656565;
            border-bottom: 1px solid #cccccc;
            font-size: 10pt;
        }

        .gh_table td.status{
            border-bottom: 1px solid #cccccc;
            font-size: 10pt;
            padding:0 20px;
        }
        .gh_table td.status .error{
            color:#f66;
        }
        
        .gh_table td{
            font-size: 10pt;
        }

        .gh_table_td_pname{
            border-bottom: none !important;
        }

        #gh_example_link{
            font-size: 6pt;
        }

        #gh_submit{
            font-size: 8pt;
        }

        .gh_messages{
            font-size: 10pt;
            color: #666;
            font-style: italic;
        }

        .form {
            margin:20px;
            background-color: #B9E6F0;
            padding: 20px;
            
            -moz-border-radius: 6px;
            -webkit-border-radius: 6px;
            -khtml-border-radius: 6px;
            border-radius: 6px;            
        }

    </style>

  </head>

  <body>

 		<h3>
            #if ($action.getMode() == 'single')
                Existing Repositories Linked to $textutils.htmlEncode($action.getProjectName())
            #else
                Bulk Configure Bitbucket Repositories
            #end
 		</h3>


            <h4 class="gh_config_h4">Existing Linked Repositories</h4>

            <table class="gh_table" cellspacing="0" cellpadding="4">

            #macro ( repositoryLineItem $projectName $projectKey )
                #set($encodedProjectName = $textutils.htmlEncode($projectName))
                <tr> <td colspan="3" class="gh_table_td_pname"><div class="gh_table_project_name">$encodedProjectName</div></td> </tr>
                <tr> <th>Repository URL</th> <th>Key</th> <th>Operations</th> </tr>
                #foreach ($repository in $action.getProjectRepositories($projectKey))
                    #set($repositoryId = $repository.getId())
                    #set($encodedMode = $textutils.htmlEncode($action.getMode()))
                    <tr>
                        <td><a href="$textutils.htmlEncode($repository.url)" target="_new">$textutils.htmlEncode($repository.url)</a></td>
                        <td>$projectKey</td>
                        <td width="260px">
                            <a href="#" onclick="forceSync($repositoryId); return false;">Force Sync</a> |
                            <a href="${baseurl}/secure/admin/ConfigureBitbucketRepositories.jspa?repositoryId=$repositoryId&nextAction=ShowPostCommitURL&mode=$encodedMode&atl_token=$atl_token">Post Commit</a> |
                            <a href="#" onclick="confirmation('${baseurl}/secure/admin/ConfigureBitbucketRepositories.jspa?nextAction=DeleteRepository&repositoryId=$repositoryId&mode=$encodedMode&atl_token=$atl_token')">Delete</a>
                        </td>
                    </tr>
                    <tr>
                        <td class="status" colspan="3">
                        <div class="gh_messages repository$repositoryId" style="display:none">
                            <div class='sync_status'></div>
                        </div>
                        </td>
                    </tr>
                #end
            #end

            #if ($action.getMode() == 'single')
                #repositoryLineItem($action.getProjectName() $action.getProjectKey())
            #else
                #foreach ($project in $action.getProjects())
                    #repositoryLineItem($project.name $project.key)
                #end
            #end

            </table>

			<div class="form">
                <p>Add additional Bitbucket repositories to the projects to link their commits with JIRA issue keys.</p>

                #if ($action.getMode() == 'single')
                    Enter the Bitbucket repository URL.</p>
                #else
                    Enter the JIRA project and Bitbucket repository URL.</p>
                #end

                #if ($action.getValidations() != "")
                    <div style="margin: 10px; border: 2px solid red; width: 400px; background: #ddd; padding: 15px;">
                           <h3>$action.getValidations() </h3>
                    </div>
                #end


                #if ($action.getNextAction() == "AddRepository" && $action.getRepoVisibility() == "private")
                    <div style='margin-bottom: 12px'>

                        <form id="privateCredentialsEntry" method="post" action="${baseurl}/secure/admin/ConfigureBitbucketRepositories.jspa">
                              <input type="hidden" name="nextAction" value="AddRepository">
                              <input type="hidden" name="url" value="$textutils.htmlEncode($action.getURL())">
                              <input type="hidden" name="projectKey" value="$action.getProjectKey()">
                              <input type="hidden" name="repoVisibility" value="private">
                              <input type="hidden" name="mode" value="$textutils.htmlEncode($action.getMode())">
                              <input type="hidden" name="atl_token" value="$atl_token">
                              <table width="300px">

                                  <tr>
                                      <td colspan="2"><h3 id='gh_post_receive_header'>Bitbucket Credentials</h3></td>
                                  </tr>


                                  <tr>
                                    <td>Username</td>
								  </tr>
								  <tr>
                                    <td><input type="text" name="bbUserName"></td>
                                  </tr>

                                  <tr>
                                    <td>Password</td>
								  </tr>
								  <tr>
                                    <td><input type="password" name="bbPassword"></td>
                                  </tr>

                                  <tr>
                                    <td>
                                        <input type="submit" value="Set Credentials">
                                    </td>
                                  </tr>
                              </table>


                        </form>

                    </div>
                #end


                #if ($action.getPostCommitURL() != "")
                    <div>
                           <h3 id="gh_post_receive_header">Add a Post-Commit Hook</h3>

                            <p>Please add the URL below as a post-commit service to the Bitbucket repository.</p>

                            <p>
								<input id="gh_post_receive_textbox" type"text" size="90" value="${baseurl}/$action.getPostCommitURL()">
                            </p>

                    </div>
                #end

                 <form id="repoEntry" method="post" action="${baseurl}/secure/admin/ConfigureBitbucketRepositories.jspa">
                      <input type="hidden" name="nextAction" value="AddRepository">
                      <input type="hidden" name="atl_token" value="$atl_token">
                      <table width="500px">

                        <tr>
                          <td valign='top'>

                                #if ($action.getMode() == 'single')
                                    <input type='hidden' name='projectKey' value='$action.getProjectKey()'>
                                    <input type='hidden' name='mode' value='single'>
                                #else

                                      <select name="projectKey">
                                        #foreach ($project in $action.getProjects())
                                          <option value="${project.key}"#if ($action.getProjectKey() == $project.key) selected #end>$textutils.htmlEncode(${project.name})</option>
                                        #end
                                      </select>
                                #end
                          </td>

                          <td valign='top'>
                              <select name="repoVisibility" id="repoVisibility">
                                  <option value="public" #if ($action.getRepoVisibility() == 'public') selected #end >Public</option>
                                  <option value="private" #if ($action.getRepoVisibility() == 'private') selected #end >Private</option>
                              </select>
                          </td>

                          <td valign='top'>
                             <input type="text"
                             id="url"
                             name="url"
                             value="$textutils.htmlEncode($action.getURL())"
                             size="60"
                             /><br/>
                          </td>

                            <td class="" valign='top'>
                                <input type="submit" name="Submit" id="Submit" value="Add Repository"/>
                            </td>
                        </tr>

                        <tr>
                            <td colspan="2"></td>
                            <td colspan="2"><strong>Example:</strong> https://bitbucket.org/atlassianguy/my-repository</td>

                        </tr>


                      </table>
                 </form>

             </div>
        #if ($action.nextAction == 'ForceSync')
            <script type="text/javascript">
                    forceSync($action.getRepositoryId());
            </script>
        #end


  </body>
</html>